<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="mobile-web-app-capable" content="yes">
    <title>
        106 OS homework 2-2 ÊàêÊûúÂ†±ÂëäÊõ∏ - HackMD
    </title>
    <link rel="icon" type="image/png" href="https://hackmd.io/favicon.png">
    <link rel="apple-touch-icon" href="https://hackmd.io/apple-touch-icon.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ionicons/2.0.1/css/ionicons.min.css" integrity="sha256-3iu9jgsy9TpTwXKb7bNQzqWekRX7pPK+2OLj3R922fo=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/octicons/3.5.0/octicons.min.css" integrity="sha256-QiWfLIsCT02Sdwkogf6YMiQlj4NE84MKkzEMkZnMGdg=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.5.1/themes/prism.min.css" integrity="sha256-vtR0hSWRc3Tb26iuN2oZHt3KRUomwTufNIf5/4oeCyg=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/github-gist.min.css" integrity="sha256-tAflq+ymku3Khs+I/WcAneIlafYgDiOQ9stIHH985Wo=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/emojify.js/1.1.0/css/basic/emojify.min.css" integrity="sha256-UOrvMOsSDSrW6szVLe8ZDZezBxh5IoIfgTwdNDgTjiU=" crossorigin="anonymous" />
    <style>
        @import url(https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400italic,600,600italic,300italic,300|Source+Serif+Pro|Source+Code+Pro:400,300,500&subset=latin,latin-ext);.markdown-body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body>:first-child{margin-top:0!important}.markdown-body>:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body .absent{color:#c00}.markdown-body .anchor{float:left;padding-right:4px;margin-left:-20px;line-height:1}.markdown-body .anchor:focus{outline:none}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e7e7e7;border:0}.markdown-body blockquote{padding:0 1em;color:#777;border-left:.25em solid #ddd}.markdown-body blockquote>:first-child{margin-top:0}.markdown-body blockquote>:last-child{margin-bottom:0}.markdown-body .loweralpha{list-style-type:lower-alpha}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#000;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1 code,.markdown-body h1 tt,.markdown-body h2 code,.markdown-body h2 tt,.markdown-body h3 code,.markdown-body h3 tt,.markdown-body h4 code,.markdown-body h4 tt,.markdown-body h5 code,.markdown-body h5 tt,.markdown-body h6 code,.markdown-body h6 tt{font-size:inherit}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eee}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#777}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol.no-list,.markdown-body ul.no-list{padding:0;list-style-type:none}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li>p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}.markdown-body table th{font-weight:700}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #ddd}.markdown-body table tr{background-color:#fff;border-top:1px solid #ccc}.markdown-body table tr:nth-child(2n){background-color:#f8f8f8}.markdown-body img{max-width:100%;box-sizing:content-box;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body .emoji{max-width:none;vertical-align:text-top;background-color:transparent}.markdown-body span.frame{display:block;overflow:hidden}.markdown-body span.frame>span{display:block;float:left;width:auto;padding:7px;margin:13px 0 0;overflow:hidden;border:1px solid #ddd}.markdown-body span.frame span img{display:block;float:left}.markdown-body span.frame span span{display:block;padding:5px 0 0;clear:both;color:#333}.markdown-body span.align-center{display:block;overflow:hidden;clear:both}.markdown-body span.align-center>span{display:block;margin:13px auto 0;overflow:hidden;text-align:center}.markdown-body span.align-center span img{margin:0 auto;text-align:center}.markdown-body span.align-right{display:block;overflow:hidden;clear:both}.markdown-body span.align-right>span{display:block;margin:13px 0 0;overflow:hidden;text-align:right}.markdown-body span.align-right span img{margin:0;text-align:right}.markdown-body span.float-left{display:block;float:left;margin-right:13px;overflow:hidden}.markdown-body span.float-left span{margin:13px 0 0}.markdown-body span.float-right{display:block;float:right;margin-left:13px;overflow:hidden}.markdown-body span.float-right>span{display:block;margin:13px auto 0;overflow:hidden;text-align:right}.markdown-body code,.markdown-body tt{padding:0;padding-top:.2em;padding-bottom:.2em;margin:0;font-size:85%;background-color:rgba(0,0,0,.04);border-radius:3px}.markdown-body code:after,.markdown-body code:before,.markdown-body tt:after,.markdown-body tt:before{letter-spacing:-.2em;content:"\A0"}.markdown-body code br,.markdown-body tt br{display:none}.markdown-body del code{text-decoration:inherit}.markdown-body pre{word-wrap:normal}.markdown-body pre>code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f7f7f7;border-radius:3px}.markdown-body pre code,.markdown-body pre tt{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}.markdown-body pre code:after,.markdown-body pre code:before,.markdown-body pre tt:after,.markdown-body pre tt:before{content:normal}.markdown-body .csv-data td,.markdown-body .csv-data th{padding:5px;overflow:hidden;font-size:12px;line-height:1;text-align:left;white-space:nowrap}.markdown-body .csv-data .blob-line-num{padding:10px 8px 9px;text-align:right;background:#fff;border:0}.markdown-body .csv-data tr{border-top:0}.markdown-body .csv-data th{font-weight:700;background:#f8f8f8;border-top:0}.markdown-body kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#555;vertical-align:middle;background-color:#fcfcfc;border:1px solid #ccc;border-bottom-color:#bbb;border-radius:3px;box-shadow:inset 0 -1px 0 #bbb}.news .alert .markdown-body blockquote{padding:0 0 0 40px;border:0 none}.activity-tab .news .alert .commits,.activity-tab .news .markdown-body blockquote{padding-left:0}.task-list-item{list-style-type:none}.task-list-item label{font-weight:400}.task-list-item.enabled label{cursor:pointer}.task-list-item+.task-list-item{margin-top:3px}.task-list-item-checkbox{float:left;margin:.31em 0 .2em -1.3em!important;vertical-align:middle;cursor:default!important}.markdown-body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Helvetica,Arial,sans-serif;padding-top:40px;padding-bottom:40px;max-width:758px;overflow:visible!important}.markdown-body pre{border:inherit!important}.markdown-body code{color:inherit!important}.markdown-body pre code .wrapper{display:-moz-inline-flex;display:-ms-inline-flex;display:-o-inline-flex;display:inline-flex}.markdown-body pre code .gutter{float:left;overflow:hidden;-webkit-user-select:none;user-select:none}.markdown-body pre code .gutter.linenumber{text-align:right;position:relative;display:inline-block;cursor:default;z-index:4;padding:0 8px 0 0;min-width:20px;box-sizing:content-box;color:#afafaf!important;border-right:3px solid #6ce26c!important}.markdown-body pre code .gutter.linenumber>span:before{content:attr(data-linenumber)}.markdown-body pre code .code{float:left;margin:0 0 0 16px}.markdown-body .gist .line-numbers{border-left:none;border-top:none;border-bottom:none}.markdown-body .gist .line-data{border:none}.markdown-body .gist table{border-spacing:0;border-collapse:inherit!important}.markdown-body code[data-gist-id]{background:none;padding:0}.markdown-body code[data-gist-id]:after,.markdown-body code[data-gist-id]:before{content:""}.markdown-body code[data-gist-id] .blob-num{border:unset}.markdown-body code[data-gist-id] table{overflow:unset;margin-bottom:unset}.markdown-body code[data-gist-id] table tr{background:unset}.markdown-body[dir=rtl] pre{direction:ltr}.markdown-body[dir=rtl] code{direction:ltr;unicode-bidi:embed}.markdown-body .alert>p{margin-bottom:0}.markdown-body pre.abc,.markdown-body pre.flow-chart,.markdown-body pre.graphviz,.markdown-body pre.mermaid,.markdown-body pre.sequence-diagram{text-align:center;background-color:inherit;border-radius:0;white-space:inherit}.markdown-body pre.abc>code,.markdown-body pre.flow-chart>code,.markdown-body pre.graphviz>code,.markdown-body pre.mermaid>code,.markdown-body pre.sequence-diagram>code{text-align:left}.markdown-body pre.abc>svg,.markdown-body pre.flow-chart>svg,.markdown-body pre.graphviz>svg,.markdown-body pre.mermaid>svg,.markdown-body pre.sequence-diagram>svg{max-width:100%;height:100%}.markdown-body pre>code.wrap{white-space:pre-wrap;white-space:-moz-pre-wrap;white-space:-pre-wrap;white-space:-o-pre-wrap;word-wrap:break-word}.markdown-body .alert>p,.markdown-body .alert>ul{margin-bottom:0}.vimeo,.youtube{cursor:pointer;display:table;text-align:center;background-position:50%;background-repeat:no-repeat;background-size:contain;background-color:#000;overflow:hidden}.vimeo,.youtube{position:relative;width:100%}.youtube{padding-bottom:56.25%}.vimeo img{width:100%;object-fit:contain;z-index:0}.youtube img{object-fit:cover;z-index:0}.vimeo iframe,.youtube iframe,.youtube img{width:100%;height:100%;position:absolute;top:0;left:0}.vimeo iframe,.youtube iframe{vertical-align:middle;z-index:1}.vimeo .icon,.youtube .icon{position:absolute;height:auto;width:auto;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;opacity:.3;transition:opacity .2s;z-index:0}.vimeo:hover .icon,.youtube:hover .icon{opacity:.6;transition:opacity .2s}.slideshare .inner,.speakerdeck .inner{position:relative;width:100%}.slideshare .inner iframe,.speakerdeck .inner iframe{position:absolute;top:0;bottom:0;left:0;right:0;width:100%;height:100%}.MJX_Assistive_MathML{display:none}.ui-infobar{position:relative;z-index:2;max-width:758px;margin-top:25px;margin-bottom:-25px;color:#777}.ui-toc{position:fixed;bottom:20px;z-index:10000}.ui-toc-label{opacity:.3;background-color:#ccc;border:none;transition:opacity .2s}.ui-toc .open .ui-toc-label{opacity:1;color:#fff;transition:opacity .2s}.ui-toc-label:focus{opacity:.3;background-color:#ccc;color:#000}.ui-toc-label:hover{opacity:1;background-color:#ccc;transition:opacity .2s}.ui-toc-dropdown{margin-top:23px;margin-bottom:20px;padding-left:10px;padding-right:10px;max-width:45vw;width:25vw;max-height:70vh;overflow:auto;text-align:inherit}.ui-toc-dropdown>.toc{max-height:calc(70vh - 100px);overflow:auto}.ui-toc-dropdown[dir=rtl] .nav{padding-right:0;letter-spacing:.0029em}.ui-toc-dropdown a{overflow:hidden;text-overflow:ellipsis;white-space:pre}.ui-toc-dropdown .nav>li>a{display:block;padding:4px 20px;font-size:13px;font-weight:500;color:#767676}.ui-toc-dropdown .nav>li:first-child:last-child > ul,.ui-toc-dropdown .toc.expand ul{display:block}.ui-toc-dropdown .nav>li>a:focus,.ui-toc-dropdown .nav>li>a:hover{padding-left:19px;color:#000;text-decoration:none;background-color:transparent;border-left:1px solid #000}.ui-toc-dropdown[dir=rtl] .nav>li>a:focus,.ui-toc-dropdown[dir=rtl] .nav>li>a:hover{padding-right:19px;border-left:none;border-right:1px solid #000}.ui-toc-dropdown .nav>.active:focus>a,.ui-toc-dropdown .nav>.active:hover>a,.ui-toc-dropdown .nav>.active>a{padding-left:18px;font-weight:700;color:#000;background-color:transparent;border-left:2px solid #000}.ui-toc-dropdown[dir=rtl] .nav>.active:focus>a,.ui-toc-dropdown[dir=rtl] .nav>.active:hover>a,.ui-toc-dropdown[dir=rtl] .nav>.active>a{padding-right:18px;border-left:none;border-right:2px solid #000}.ui-toc-dropdown .nav .nav{display:none;padding-bottom:10px}.ui-toc-dropdown .nav>.active>ul{display:block}.ui-toc-dropdown .nav .nav>li>a{padding-top:1px;padding-bottom:1px;padding-left:30px;font-size:12px;font-weight:400}.ui-toc-dropdown[dir=rtl] .nav .nav>li>a{padding-right:30px}.ui-toc-dropdown .nav .nav>li>ul>li>a{padding-top:1px;padding-bottom:1px;padding-left:40px;font-size:12px;font-weight:400}.ui-toc-dropdown[dir=rtl] .nav .nav>li>ul>li>a{padding-right:40px}.ui-toc-dropdown .nav .nav>li>a:focus,.ui-toc-dropdown .nav .nav>li>a:hover{padding-left:29px}.ui-toc-dropdown[dir=rtl] .nav .nav>li>a:focus,.ui-toc-dropdown[dir=rtl] .nav .nav>li>a:hover{padding-right:29px}.ui-toc-dropdown .nav .nav>li>ul>li>a:focus,.ui-toc-dropdown .nav .nav>li>ul>li>a:hover{padding-left:39px}.ui-toc-dropdown[dir=rtl] .nav .nav>li>ul>li>a:focus,.ui-toc-dropdown[dir=rtl] .nav .nav>li>ul>li>a:hover{padding-right:39px}.ui-toc-dropdown .nav .nav>.active:focus>a,.ui-toc-dropdown .nav .nav>.active:hover>a,.ui-toc-dropdown .nav .nav>.active>a{padding-left:28px;font-weight:500}.ui-toc-dropdown[dir=rtl] .nav .nav>.active:focus>a,.ui-toc-dropdown[dir=rtl] .nav .nav>.active:hover>a,.ui-toc-dropdown[dir=rtl] .nav .nav>.active>a{padding-right:28px}.ui-toc-dropdown .nav .nav>.active>.nav>.active:focus>a,.ui-toc-dropdown .nav .nav>.active>.nav>.active:hover>a,.ui-toc-dropdown .nav .nav>.active>.nav>.active>a{padding-left:38px;font-weight:500}.ui-toc-dropdown[dir=rtl] .nav .nav>.active>.nav>.active:focus>a,.ui-toc-dropdown[dir=rtl] .nav .nav>.active>.nav>.active:hover>a,.ui-toc-dropdown[dir=rtl] .nav .nav>.active>.nav>.active>a{padding-right:38px}.markdown-body[lang^=ja]{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Helvetica,Arial,Hiragino Kaku Gothic Pro,\\30D2\30E9\30AE\30CE\89D2\30B4 Pro W3,Osaka,Meiryo,\\30E1\30A4\30EA\30AA,MS Gothic,"\FF2D\FF33   \30B4\30B7\30C3\30AF",sans-serif}.ui-toc-dropdown[lang^=ja]{font-family:Source Sans Pro,Helvetica,Arial,Meiryo UI,MS PGothic,"\FF2D\FF33   \FF30\30B4\30B7\30C3\30AF",sans-serif}.markdown-body[lang=zh-tw]{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Helvetica,Arial,PingFang TC,Microsoft JhengHei,\\5FAE\8EDF\6B63\9ED1,sans-serif}.ui-toc-dropdown[lang=zh-tw]{font-family:Source Sans Pro,Helvetica,Arial,Microsoft JhengHei UI,\\5FAE\8EDF\6B63\9ED1UI,sans-serif}.markdown-body[lang=zh-cn]{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Helvetica,Arial,PingFang SC,Microsoft YaHei,\\5FAE\8F6F\96C5\9ED1,sans-serif}.ui-toc-dropdown[lang=zh-cn]{font-family:Source Sans Pro,Helvetica,Arial,Microsoft YaHei UI,\\5FAE\8F6F\96C5\9ED1UI,sans-serif}.ui-affix-toc{position:fixed;top:0;max-width:15vw;max-height:70vh;overflow:auto}.back-to-top,.expand-toggle,.go-to-bottom{display:block;padding:4px 10px;margin-top:10px;margin-left:10px;font-size:12px;font-weight:500;color:#999}.back-to-top:focus,.back-to-top:hover,.expand-toggle:focus,.expand-toggle:hover,.go-to-bottom:focus,.go-to-bottom:hover{color:#563d7c;text-decoration:none}.back-to-top,.go-to-bottom{margin-top:0}.ui-user-icon{width:20px;height:20px;display:block;border-radius:3px;margin-top:2px;margin-bottom:2px;margin-right:5px;background-position:50%;background-repeat:no-repeat;background-size:contain}.ui-user-icon.small{width:18px;height:18px;display:inline-block;vertical-align:middle;margin:0 0 .2em}.ui-infobar>small>span{line-height:22px}.ui-infobar>small .dropdown{display:inline-block}.ui-infobar>small .dropdown a:focus,.ui-infobar>small .dropdown a:hover{text-decoration:none}.unselectable{-moz-user-select:none;-webkit-user-select:none;-o-user-select:none;user-select:none}@media print{blockquote,div,img,pre,table{page-break-inside:avoid!important}a[href]:after{font-size:12px!important}}.markdown-body.slides{position:relative;z-index:1;color:#222}.markdown-body.slides:before{content:"";display:block;position:absolute;top:0;left:0;right:0;bottom:0;z-index:-1;background-color:currentColor;box-shadow:0 0 0 50vw}.markdown-body.slides section[data-markdown]{position:relative;margin-bottom:1.5em;background-color:#fff;text-align:center}.markdown-body.slides section[data-markdown] code{text-align:left}.markdown-body.slides section[data-markdown]:before{content:"";display:block;padding-bottom:56.23%}.markdown-body.slides section[data-markdown]>div:first-child{position:absolute;top:50%;left:1em;right:1em;transform:translateY(-50%);max-height:100%;overflow:hidden}.markdown-body.slides section[data-markdown]>ul{display:inline-block}.markdown-body.slides>section>section+section:after{content:"";position:absolute;top:-1.5em;right:1em;height:1.5em;border:3px solid #777}body{font-smoothing:subpixel-antialiased!important;-webkit-font-smoothing:subpixel-antialiased!important;-moz-osx-font-smoothing:auto!important;text-shadow:0 0 1em transparent,1px 1px 1.2px rgba(0,0,0,.004);-webkit-overflow-scrolling:touch;font-family:Source Sans Pro,Helvetica,Arial,sans-serif;letter-spacing:.025em}.focus,:focus{outline:none!important}::-moz-focus-inner{border:0!important}body.modal-open{overflow-y:auto;padding-right:0!important}
    </style>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    	<script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js" integrity="sha256-3Jy/GbSLrg0o9y5Z5n1uw0qxZECH7C6OQpVBgNFYa0g=" crossorigin="anonymous"></script>
    	<script src="https://cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js" integrity="sha256-g6iAfvZp+nDQ2TdTR/VVKJf3bGro4ub5fvWSWVRi2NE=" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.9/es5-shim.min.js" integrity="sha256-8E4Is26QH0bD52WoQpcB+R/tcWQtpzlCojrybUd7Mxo=" crossorigin="anonymous"></script>
    <![endif]-->
</head>

<body>
    <div id="doc" class="markdown-body container-fluid" style="position: relative;"><h1 id="106-os-homework-2-2-ÊàêÊûúÂ†±ÂëäÊõ∏"><a class="anchor hidden-xs" href="#106-os-homework-2-2-ÊàêÊûúÂ†±ÂëäÊõ∏" title="106-os-homework-2-2-ÊàêÊûúÂ†±ÂëäÊõ∏"><span class="octicon octicon-link"></span></a>106 OS homework 2-2 ÊàêÊûúÂ†±ÂëäÊõ∏</h1><blockquote>
<p>ÁµÑÈï∑ÔºöB10431031 ÊûóË®ÄÈÅî<br>
ÁµÑÂì°Ôºö<br>
ÁµÑÂì°Ôºö<br>
github: <a href="https://github.com/segnoda/xv6-public" target="_blank">https://github.com/segnoda/xv6-public</a></p>
</blockquote><hr><h1 id="üôÇ-‰ΩøÁî®ÊÉÖÂ¢ÉË™™ÊòéÂåÖÂê´ÊµÅÁ®ãÂúñ"><a class="anchor hidden-xs" href="#üôÇ-‰ΩøÁî®ÊÉÖÂ¢ÉË™™ÊòéÂåÖÂê´ÊµÅÁ®ãÂúñ" title="üôÇ-‰ΩøÁî®ÊÉÖÂ¢ÉË™™ÊòéÂåÖÂê´ÊµÅÁ®ãÂúñ"><span class="octicon octicon-link"></span></a>üôÇ ‰ΩøÁî®ÊÉÖÂ¢ÉË™™Êòé(ÂåÖÂê´ÊµÅÁ®ãÂúñ)</h1><p>When we wants to utilize all the threads of CPU in some programs such as image processing, rendering of animation or web server, we can use multi-threaded program to do so.</p><p>To demonstrate how to use multi-threaded program, we are going to write a multi-threaded counter by the following cases.</p><h2 id="first-case"><a class="anchor hidden-xs" href="#first-case" title="first-case"><span class="octicon octicon-link"></span></a>First Case</h2><p>First, we create a global variable <code>g_counter</code> as a counter for all threads to use. <code>g_counter</code> should be first initialized as 0.</p><p>Then, we can start to create threads to increase the count of <code>g_counter</code>. For each thread, we need 4KB of memory as a stack and argument for the function. We use <code>(void *)malloc(4096)</code> to allocate from heap and <code>(int *)malloc(4)</code> for 4 byte single argument.</p><p>We also need a function to perform computing, which is <code>void counter(void *args)</code>. In <code>counter()</code>, we use a <code>for</code> loop to increase <code>g_counter</code> for 5000 times. We decided to utilize 8 threads to execute <code>counter()</code>. Therefore, at the end of the program, we should have total number of 8 * 5000 = 40000 in <code>g_counter</code>. We can define a variable <code>final_target</code> to check the result of <code>g_counter</code>.</p><p>Finally, we can use <code>clone()</code> to create and start all the threads as well as <code>join()</code> to wait for all the threads.</p><p>The structure of the multi-threaded counter should be look like this:</p><pre><code class="c hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> NUM_THREADS 8</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> TARGET_COUNT_PER_THREAD 5000</span>

<span class="hljs-keyword">int</span> g_counter;

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">counter</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span>
</span>{
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; TARGET_COUNT_PER_THREAD; i++){
    g_counter = g_counter + <span class="hljs-number">1</span>;
  }
  <span class="hljs-built_in">exit</span>();
}

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span>
</span>{
  <span class="hljs-keyword">int</span> final_target = NUM_THREADS * TARGET_COUNT_PER_THREAD;
  g_counter = <span class="hljs-number">0</span>;

  <span class="hljs-keyword">void</span> *stacks[NUM_THREADS];
  <span class="hljs-keyword">int</span> *args[NUM_THREADS];
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; NUM_THREADS; i++){
    stacks[i] = (<span class="hljs-keyword">void</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">4096</span>);
    args[i] = (<span class="hljs-keyword">int</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">4</span>);
    *args[i] = i;
  }

  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; NUM_THREADS; i++){
    clone(counter, args[i], stacks[i]);
  }

  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; NUM_THREADS; i++){
    <span class="hljs-keyword">void</span> *joinstack;
    join(&amp;joinstack);
  } 

  <span class="hljs-built_in">printf</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"g_counter is %d\n"</span>, g_counter);
  <span class="hljs-built_in">printf</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"final_target is %d\n"</span>, final_target);
  <span class="hljs-keyword">if</span>(g_counter == final_target)
    <span class="hljs-built_in">printf</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"TEST PASSED!\n"</span>);
  <span class="hljs-keyword">else</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"TEST FAILED!\n"</span>);

  <span class="hljs-built_in">exit</span>();
}
</code></pre><p>As we run this program, we should get:</p><pre><code class="shell hljs">g_counter <span class="hljs-keyword">is</span> <span class="hljs-number">40000</span>
final_target <span class="hljs-keyword">is</span> <span class="hljs-number">40000</span>
TEST PASSED!
</code></pre><h2 id="second-case"><a class="anchor hidden-xs" href="#second-case" title="second-case"><span class="octicon octicon-link"></span></a>Second Case</h2><p><strong>Always consider the worst case!</strong></p><p>If we not just run <code>g_counter = g_counter + 1</code> inside <code>for</code> loop. Instead, we have the following code:</p><pre><code class="c hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">counter</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span>
</span>{
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; TARGET_COUNT_PER_THREAD; i++){
    <span class="hljs-keyword">int</span> temp = g_counter;
    temp = temp + <span class="hljs-number">1</span>;
    sleep(<span class="hljs-number">0</span>);
    g_counter = temp;
  }
  <span class="hljs-built_in">exit</span>();
}
</code></pre><p>Which do the same thing but in a more complex way, we get the result:</p><pre><code class="shell hljs">g_counter <span class="hljs-keyword">is</span> <span class="hljs-number">9730</span>
final_target <span class="hljs-keyword">is</span> <span class="hljs-number">40000</span>
TEST FAILED!
</code></pre><p>This is the so-called race condition.</p><h2 id="race-condition"><a class="anchor hidden-xs" href="#race-condition" title="race-condition"><span class="octicon octicon-link"></span></a>Race Condition</h2><p>We found that the reason of not having race condition in the first case is that the compiler is smart enougth to simplify those codes into one line of assembly. The idea of simplifying is:</p><pre><code class="c hljs"><span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; TARGET_COUNT_PER_THREAD; i++){
    g_counter = g_counter + <span class="hljs-number">1</span>;
}
</code></pre><p><span class="mathjax"><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-1-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mo stretchy=&quot;false&quot;>&amp;#x2193;</mo></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-1" style="width: 0.72em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.566em; height: 0px; font-size: 122%;"><span style="position: absolute; clip: rect(1.744em, 1000.515em, 2.871em, -999.997em); top: -2.559em; left: 0em;"><span class="mrow" id="MathJax-Span-2"><span class="mo" id="MathJax-Span-3" style="font-family: STIXGeneral-Regular;">‚Üì</span></span><span style="display: inline-block; width: 0px; height: 2.564em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left-width: 0px; border-left-style: solid; width: 0px; height: 1.128em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo stretchy="false">‚Üì</mo></math></span></span><script type="math/tex" id="MathJax-Element-1">\downarrow</script></span></p><pre><code class="c hljs"><span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5000</span>; i++){
    g_counter = g_counter + <span class="hljs-number">1</span>;
}
</code></pre><p><span class="mathjax"><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-2-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mo stretchy=&quot;false&quot;>&amp;#x2193;</mo></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-4" style="width: 0.72em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.566em; height: 0px; font-size: 122%;"><span style="position: absolute; clip: rect(1.744em, 1000.515em, 2.871em, -999.997em); top: -2.559em; left: 0em;"><span class="mrow" id="MathJax-Span-5"><span class="mo" id="MathJax-Span-6" style="font-family: STIXGeneral-Regular;">‚Üì</span></span><span style="display: inline-block; width: 0px; height: 2.564em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left-width: 0px; border-left-style: solid; width: 0px; height: 1.128em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo stretchy="false">‚Üì</mo></math></span></span><script type="math/tex" id="MathJax-Element-2">\downarrow</script></span></p><pre><code class="c hljs"><span class="hljs-attr">g_counter</span> = g_counter + <span class="hljs-number">5000</span>;
</code></pre><p><span class="mathjax"><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-3-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mo stretchy=&quot;false&quot;>&amp;#x2193;</mo></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-7" style="width: 0.72em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.566em; height: 0px; font-size: 122%;"><span style="position: absolute; clip: rect(1.744em, 1000.515em, 2.871em, -999.997em); top: -2.559em; left: 0em;"><span class="mrow" id="MathJax-Span-8"><span class="mo" id="MathJax-Span-9" style="font-family: STIXGeneral-Regular;">‚Üì</span></span><span style="display: inline-block; width: 0px; height: 2.564em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left-width: 0px; border-left-style: solid; width: 0px; height: 1.128em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo stretchy="false">‚Üì</mo></math></span></span><script type="math/tex" id="MathJax-Element-3">\downarrow</script></span></p><pre><code class="asm hljs"><span class="hljs-attribute">addl</span>   <span class="hljs-number">$0</span>x1388,0xb00    ;0x1388 == 5000, &amp;g_counter == 0xb00
</code></pre><p>The one-line assembly is atomic. Therefore, there is no race condition in first case.</p><p>However, compiler can not simplify the second case, which cause the race condition. In order to avoid race condition, we need to use semaphore to create a critical section.</p><h2 id="semaphore0"><a class="anchor hidden-xs" href="#semaphore0" title="semaphore0"><span class="octicon octicon-link"></span></a>Semaphore</h2><p>To achieve all the functions of semaphore, we implemented <code>sem_init()</code>, <code>sem_destroy()</code>, <code>sem_wait()</code> and <code>sem_signal()</code> four system calls.</p><ul>
<li><code>sem_init()</code> initialize the id and size of semaphore.</li>
<li><code>sem_destroy()</code> delete the target semaphore.</li>
<li><code>sem_wait()</code> wait until a unit of the resource becomes available, and decrease semaphore value by given number.</li>
<li><code>sem_signal()</code> increase the value of semaphore variable by given number.</li>
</ul><p>Finally, we can use semaphore inside our multi-threaded counter.</p><h2 id="final-case"><a class="anchor hidden-xs" href="#final-case" title="final-case"><span class="octicon octicon-link"></span></a>Final Case</h2><p>First, we use <code>sem_init()</code> to initialize the size of the semaphore. Because only one thread can access <code>g_counter</code> at one time, the size of <code>sem_size</code> should be 1. We also set the id of semaphore as <code>SEMAPHORE_NUM</code>.</p><p>Inside the <code>for</code> loop in <code>counter()</code>, we put the actually code between <code>sem_wait()</code> and <code>sem_signal()</code> to create critical section.</p><p>After finishing all the computing, we use <code>sem_destroy()</code> to delete the semaphore.</p><p>The structure of the final case should be look like this:</p><pre><code class="c hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> NUM_THREADS 8</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> TARGET_COUNT_PER_THREAD 5000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SEMAPHORE_NUM 0</span>

<span class="hljs-keyword">int</span> g_counter;

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">counter</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span>
</span>{
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; TARGET_COUNT_PER_THREAD; i++){
    sem_wait(SEMAPHORE_NUM, <span class="hljs-number">1</span>);
    <span class="hljs-keyword">int</span> temp = g_counter;
    temp = temp + <span class="hljs-number">1</span>;
    sleep(<span class="hljs-number">0</span>);
    g_counter = temp;
    sem_signal(SEMAPHORE_NUM, <span class="hljs-number">1</span>);
  }
  <span class="hljs-built_in">exit</span>();
}

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span>
</span>{
  <span class="hljs-keyword">int</span> sem_size = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">int</span> final_target = NUM_THREADS * TARGET_COUNT_PER_THREAD;
  g_counter = <span class="hljs-number">0</span>;
  
  sem_init(SEMAPHORE_NUM, sem_size);

  <span class="hljs-keyword">void</span> *stacks[NUM_THREADS];
  <span class="hljs-keyword">int</span> *args[NUM_THREADS];
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; NUM_THREADS; i++){
    stacks[i] = (<span class="hljs-keyword">void</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">4096</span>);
    args[i] = (<span class="hljs-keyword">int</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">4</span>);
    *args[i] = i;
  }

  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; NUM_THREADS; i++){
    clone(counter, args[i], stacks[i]);
  }

  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; NUM_THREADS; i++){
    <span class="hljs-keyword">void</span> *joinstack;
    join(&amp;joinstack);
  } 

  <span class="hljs-built_in">printf</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"g_counter is %d\n"</span>, g_counter);
  <span class="hljs-built_in">printf</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"final_target is %d\n"</span>, final_target);
  <span class="hljs-keyword">if</span>(g_counter == final_target)
    <span class="hljs-built_in">printf</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"TEST PASSED!\n"</span>);
  <span class="hljs-keyword">else</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"TEST FAILED!\n"</span>);
    
  sem_destroy(SEMAPHORE_NUM);

  <span class="hljs-built_in">exit</span>();
}
</code></pre><h2 id="flow"><a class="anchor hidden-xs" href="#flow" title="flow"><span class="octicon octicon-link"></span></a>Flow</h2><p>We can conclude the flow of multi-threaded counter with two simple flow charts.</p><p>The first one is <code>main</code> function, which do five things:</p><ul>
<li>Initialize counter, semaphore, stack and arguments.</li>
<li>Create all threads.</li>
<li>Join all threads.</li>
<li>Verify correctness of counter.</li>
<li>Destroy semaphore</li>
</ul><p><img src="https://i.imgur.com/UfbVe2j.png" alt=""></p><p>The second one is <code>counter()</code> function, which create critical section inside <code>for</code> loop.</p><p><img src="https://i.imgur.com/CrUcgXM.png" alt=""></p><hr><h1 id="üòá-ÊàêÂäüÁï´Èù¢"><a class="anchor hidden-xs" href="#üòá-ÊàêÂäüÁï´Èù¢" title="üòá-ÊàêÂäüÁï´Èù¢"><span class="octicon octicon-link"></span></a>üòá ÊàêÂäüÁï´Èù¢</h1><p>In the final case, we add some messages while initializing semaphore and threads.</p><p><img src="https://i.imgur.com/kv3sHIB.png" alt=""></p><hr><h1 id="üèÉ-ÂØ¶‰ΩúÈÅéÁ®ã‰øÆÊîπÂì™‰∫õÊ™îÊ°àÂê´ÂúñÁâá"><a class="anchor hidden-xs" href="#üèÉ-ÂØ¶‰ΩúÈÅéÁ®ã‰øÆÊîπÂì™‰∫õÊ™îÊ°àÂê´ÂúñÁâá" title="üèÉ-ÂØ¶‰ΩúÈÅéÁ®ã‰øÆÊîπÂì™‰∫õÊ™îÊ°àÂê´ÂúñÁâá"><span class="octicon octicon-link"></span></a>üèÉ ÂØ¶‰ΩúÈÅéÁ®ã(‰øÆÊîπÂì™‰∫õÊ™îÊ°à[Âê´ÂúñÁâá])</h1><p>During the development, we separated the development process into two parts. One is semaphore, another is thread. In order to add system calls, we need to modify several files.</p><h2 id="semaphore"><a class="anchor hidden-xs" href="#semaphore" title="semaphore"><span class="octicon octicon-link"></span></a>Semaphore</h2><p>In <code>defs.h</code>, we add system call prototype for <code>semaphore.c</code>.</p><pre><code class="diff hljs">@@ -9,6 +9,7 @@ struct spinlock;
 struct sleeplock;
 struct stat;
 struct superblock;
<span class="hljs-addition">+struct semaphore;</span>
 
 // bio.c
 void            binit(void);
@@ -186,5 +187,12 @@ void            switchkvm(void);
 int             copyout(pde_t*, uint, void*, uint);
 void            clearpteu(pde_t *pgdir, char *uva);
 
<span class="hljs-addition">+//semaphore.c</span>
<span class="hljs-addition">+void            seminit(void);</span>
<span class="hljs-addition">+int             sem_init(int, int);</span>
<span class="hljs-addition">+int             sem_destroy(int);</span>
<span class="hljs-addition">+int             sem_wait(int, int);</span>
<span class="hljs-addition">+int             sem_signal(int, int);</span>
<span class="hljs-addition">+</span>
 // number of elements in fixed-size array
 #define NELEM(x) (sizeof(x)/sizeof((x)[0]))
</code></pre><p>In <code>semaphore.c</code>, we implement all semaphore system calls, including <code>sem_init()</code>, <code>sem_destroy()</code>, <code>sem_wait()</code> and <code>sem_signal()</code>.</p><pre><code class="diff hljs"><span class="hljs-meta">@@ -0,0 +1,81 @@</span>
<span class="hljs-addition">+#include "types.h"</span>
<span class="hljs-addition">+#include "x86.h"</span>
<span class="hljs-addition">+#include "defs.h"</span>
<span class="hljs-addition">+#include "param.h"</span>
<span class="hljs-addition">+#include "spinlock.h"</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+#define SEMNUM 32</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+struct semaphore {</span>
<span class="hljs-addition">+  int value;</span>
<span class="hljs-addition">+  int active;</span>
<span class="hljs-addition">+  struct spinlock lock;</span>
<span class="hljs-addition">+} sem[SEMNUM];</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+void</span>
<span class="hljs-addition">+seminit(void)</span>
<span class="hljs-addition">+{</span>
<span class="hljs-addition">+  for(int i = 0; i &lt; SEMNUM; ++i) {</span>
<span class="hljs-addition">+    initlock(&amp;sem[i].lock, "semaphore");</span>
<span class="hljs-addition">+    sem[i].active = sem[i].value = 0;</span>
<span class="hljs-addition">+  }</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+int</span>
<span class="hljs-addition">+sem_init(int num, int max)</span>
<span class="hljs-addition">+{</span>
<span class="hljs-addition">+  if(num &lt; 0 || num &gt;= SEMNUM) return -1;</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+  acquire(&amp;sem[num].lock);</span>
<span class="hljs-addition">+  if(sem[num].active != 0) return -1;</span>
<span class="hljs-addition">+  sem[num].value = max;</span>
<span class="hljs-addition">+  sem[num].active = 1;</span>
<span class="hljs-addition">+  release(&amp;sem[num].lock);</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+  return 0;</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+int</span>
<span class="hljs-addition">+sem_destroy(int num)</span>
<span class="hljs-addition">+{</span>
<span class="hljs-addition">+  if(num &lt; 0 || num &gt;= SEMNUM) return -1;</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+  acquire(&amp;sem[num].lock);</span>
<span class="hljs-addition">+  if(sem[num].active != 1) return -1;</span>
<span class="hljs-addition">+  sem[num].active = 0;</span>
<span class="hljs-addition">+  release(&amp;sem[num].lock);</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+  return 0;</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+int</span>
<span class="hljs-addition">+sem_wait(int num, int count)</span>
<span class="hljs-addition">+{</span>
<span class="hljs-addition">+  if(num &lt; 0 || num &gt;= SEMNUM) return -1;</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+  acquire(&amp;sem[num].lock);</span>
<span class="hljs-addition">+  if(!sem[num].active) return -1;</span>
<span class="hljs-addition">+  while(sem[num].value &lt;= count - 1) {</span>
<span class="hljs-addition">+    sleep(&amp;sem[num], &amp;sem[num].lock);</span>
<span class="hljs-addition">+  }</span>
<span class="hljs-addition">+  sem[num].value -= count;</span>
<span class="hljs-addition">+  release(&amp;sem[num].lock);</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+  return 0;</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+int</span>
<span class="hljs-addition">+sem_signal(int num, int count)</span>
<span class="hljs-addition">+{</span>
<span class="hljs-addition">+  if(num &lt; 0 || num &gt;= SEMNUM) return -1;</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+  acquire(&amp;sem[num].lock);</span>
<span class="hljs-addition">+  if(!sem[num].active) return -1;</span>
<span class="hljs-addition">+  sem[num].value += count;</span>
<span class="hljs-addition">+  if(sem[num].value &gt; 0){</span>
<span class="hljs-addition">+    wakeup(&amp;sem[num]);</span>
<span class="hljs-addition">+  }</span>
<span class="hljs-addition">+  release(&amp;sem[num].lock);</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+  return 0;</span>
<span class="hljs-addition">+}</span>
</code></pre><p>In <code>syscall.h</code>, we add some system call numbers.</p><pre><code class="diff hljs"><span class="hljs-meta">@@ -20,3 +20,7 @@</span>
 #define SYS_link   19
 #define SYS_mkdir  20
 #define SYS_close  21
<span class="hljs-addition">+#define SYS_sem_init    22</span>
<span class="hljs-addition">+#define SYS_sem_destroy 23</span>
<span class="hljs-addition">+#define SYS_sem_wait    24</span>
<span class="hljs-addition">+#define SYS_sem_signal  25</span>
</code></pre><p>In <code>syscall.c</code>, we add system call wrapper prototype for semaphore.</p><pre><code class="diff hljs">@@ -103,6 +103,10 @@ extern int sys_unlink(void);
 extern int sys_wait(void);
 extern int sys_write(void);
 extern int sys_uptime(void);
<span class="hljs-addition">+extern int sys_sem_init(void);</span>
<span class="hljs-addition">+extern int sys_sem_destroy(void);</span>
<span class="hljs-addition">+extern int sys_sem_wait(void);</span>
<span class="hljs-addition">+extern int sys_sem_signal(void);</span>
 
 static int (*syscalls[])(void) = {
 [SYS_fork]    sys_fork,
@@ -126,6 +130,10 @@ static int (*syscalls[])(void) = {
 [SYS_link]    sys_link,
 [SYS_mkdir]   sys_mkdir,
 [SYS_close]   sys_close,
<span class="hljs-addition">+[SYS_sem_init]     sys_sem_init,</span>
<span class="hljs-addition">+[SYS_sem_destroy]  sys_sem_destroy,</span>
<span class="hljs-addition">+[SYS_sem_wait]     sys_sem_wait,</span>
<span class="hljs-addition">+[SYS_sem_signal]   sys_sem_signal</span>
 };
</code></pre><p>In <code>sysproc.c</code>, we implement system call wrapper for semaphore.</p><pre><code class="diff hljs">@@ -89,3 +89,42 @@ sys_uptime(void)
   release(&amp;tickslock);
   return xticks;
 }
<span class="hljs-addition">+</span>
<span class="hljs-addition">+int</span>
<span class="hljs-addition">+sys_sem_init(void)</span>
<span class="hljs-addition">+{</span>
<span class="hljs-addition">+  int num, max;</span>
<span class="hljs-addition">+  if(argint(0, &amp;num) &lt; 0) return -1;</span>
<span class="hljs-addition">+  if(argint(1, &amp;max) &lt; 0) return -1;</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+  return sem_init(num, max);</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+int</span>
<span class="hljs-addition">+sys_sem_destroy(void)</span>
<span class="hljs-addition">+{</span>
<span class="hljs-addition">+  int num;</span>
<span class="hljs-addition">+  if(argint(0, &amp;num) &lt; 0) return -1;</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+  return sem_destroy(num);</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+int</span>
<span class="hljs-addition">+sys_sem_wait(void)</span>
<span class="hljs-addition">+{</span>
<span class="hljs-addition">+  int num, count;</span>
<span class="hljs-addition">+  if(argint(0, &amp;num) &lt; 0) return -1;</span>
<span class="hljs-addition">+  if(argint(1, &amp;count) &lt; 0) return -1;</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+  return sem_wait(num, count);</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+int</span>
<span class="hljs-addition">+sys_sem_signal(void)</span>
<span class="hljs-addition">+{</span>
<span class="hljs-addition">+  int num, count;</span>
<span class="hljs-addition">+  if(argint(0, &amp;num) &lt; 0) return -1;</span>
<span class="hljs-addition">+  if(argint(1, &amp;count) &lt; 0) return -1;</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+  return sem_signal(num, count);</span>
<span class="hljs-addition">+}</span>
</code></pre><p>In <code>user.h</code>, we add system call prototype for user program.</p><pre><code class="diff hljs">@@ -23,6 +23,10 @@ int getpid(void);
 char* sbrk(int);
 int sleep(int);
 int uptime(void);
<span class="hljs-addition">+int sem_init(int, int);</span>
<span class="hljs-addition">+int sem_destroy(int);</span>
<span class="hljs-addition">+int sem_wait(int, int);</span>
<span class="hljs-addition">+int sem_signal(int, int);</span>
</code></pre><p>In <code>usys.S</code>, we add system calls to system call table.</p><pre><code class="diff hljs">@@ -29,3 +29,7 @@ SYSCALL(getpid)
 SYSCALL(sbrk)
 SYSCALL(sleep)
 SYSCALL(uptime)
<span class="hljs-addition">+SYSCALL(sem_init)</span>
<span class="hljs-addition">+SYSCALL(sem_destroy)</span>
<span class="hljs-addition">+SYSCALL(sem_wait)</span>
<span class="hljs-addition">+SYSCALL(sem_signal)</span>

</code></pre><p>In <code>main.c</code>, we add <code>seminit()</code> to initialize semaphore table.</p><pre><code class="diff hljs">@@ -27,6 +27,7 @@ main(void)
   consoleinit();   // console hardware
   uartinit();      // serial port
   pinit();         // process table
<span class="hljs-addition">+  seminit();       // semaphore table</span>
</code></pre><h2 id="thread"><a class="anchor hidden-xs" href="#thread" title="thread"><span class="octicon octicon-link"></span></a>Thread</h2><p>In <code>defs.h</code>, we add system call prototype for <code>proc.c</code>.</p><pre><code class="diff hljs">@@ -121,6 +121,8 @@ void            userinit(void);
 int             wait(void);
 void            wakeup(void*);
 void            yield(void);
<span class="hljs-addition">+int             clone(void*, void*, void*);</span>
<span class="hljs-addition">+int             join(void**);</span>
</code></pre><p>In <code>proc.h</code>, we add some variables in <code>struct proc</code>.</p><pre><code class="diff hljs">@@ -49,6 +49,8 @@ struct proc {
   struct file *ofile[NOFILE];  // Open files
   struct inode *cwd;           // Current directory
   char name[16];               // Process name (debugging)
<span class="hljs-addition">+  int isthread;                // Is thread or not</span>
<span class="hljs-addition">+  int stack;                   // thread's stack address</span>
 };
</code></pre><p>In <code>proc.c</code>, we implement all thread system calls, including <code>clone()</code> and <code>join()</code>. We also tweak the <code>exit()</code> system call.</p><pre><code class="diff hljs">@@ -256,6 +256,12 @@ exit(void)
   for(p = ptable.proc; p &lt; &amp;ptable.proc[NPROC]; p++){
     if(p-&gt;parent == curproc){
       p-&gt;parent = initproc;
<span class="hljs-addition">+      // clean up the kernel stack of child threads</span>
<span class="hljs-addition">+      if(p-&gt;isthread == 1){</span>
<span class="hljs-addition">+        p-&gt;state = UNUSED;</span>
<span class="hljs-addition">+        kfree(p-&gt;kstack);</span>
<span class="hljs-addition">+        p-&gt;kstack = 0;</span>
<span class="hljs-addition">+      }</span>
       if(p-&gt;state == ZOMBIE)
         wakeup1(initproc);
     }
@@ -532,3 +538,114 @@ procdump(void)
     cprintf("\n");
   }
 }
<span class="hljs-addition">+</span>
<span class="hljs-addition">+int</span>
<span class="hljs-addition">+clone(void* function, void *arg, void *stack)</span>
<span class="hljs-addition">+{</span>
<span class="hljs-addition">+  int i, pid;</span>
<span class="hljs-addition">+  struct proc *np;</span>
<span class="hljs-addition">+  struct proc *curproc = myproc();</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+  // Allocate process.</span>
<span class="hljs-addition">+  if((np = allocproc()) == 0){</span>
<span class="hljs-addition">+    return -1;</span>
<span class="hljs-addition">+  }</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+  // Copy process state from proc.</span>
<span class="hljs-addition">+  //if((np-&gt;pgdir = copyuvm(curproc-&gt;pgdir, curproc-&gt;sz)) == 0){</span>
<span class="hljs-addition">+  //  kfree(np-&gt;kstack);</span>
<span class="hljs-addition">+  //  np-&gt;kstack = 0;</span>
<span class="hljs-addition">+  //  np-&gt;state = UNUSED;</span>
<span class="hljs-addition">+  //  return -1;</span>
<span class="hljs-addition">+  //}</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+  np-&gt;sz = curproc-&gt;sz;</span>
<span class="hljs-addition">+  //np-&gt;parent = curproc;</span>
<span class="hljs-addition">+  // if the process calling clone is itself a thread,</span>
<span class="hljs-addition">+  // copy its parent to the new thread</span>
<span class="hljs-addition">+  if(curproc-&gt;isthread == 0){</span>
<span class="hljs-addition">+    np-&gt;parent = curproc;</span>
<span class="hljs-addition">+  }</span>
<span class="hljs-addition">+  else{</span>
<span class="hljs-addition">+    np-&gt;parent = curproc-&gt;parent;</span>
<span class="hljs-addition">+  }</span>
<span class="hljs-addition">+  *np-&gt;tf = *curproc-&gt;tf;</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+  // Clear %eax so that fork returns 0 in the child.</span>
<span class="hljs-addition">+  np-&gt;tf-&gt;eax = 0;</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+  // reallocate old process's page table to new process</span>
<span class="hljs-addition">+  np-&gt;pgdir = curproc-&gt;pgdir;</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+  // modified the return ip to thread function</span>
<span class="hljs-addition">+  np-&gt;tf-&gt;eip = (int)function;</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+  // modified the return ip to thread function</span>
<span class="hljs-addition">+  np-&gt;isthread = 1;</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+  // modified the stack</span>
<span class="hljs-addition">+  np-&gt;stack = (int)stack;</span>
<span class="hljs-addition">+  np-&gt;tf-&gt;esp = (int)stack + 4092;</span>
<span class="hljs-addition">+  *((int *)(np-&gt;tf-&gt;esp)) = (int)arg; // push the argument</span>
<span class="hljs-addition">+  *((int *)(np-&gt;tf-&gt;esp - 4)) = 0xFFFFFFFF; // push the return address</span>
<span class="hljs-addition">+  np-&gt;tf-&gt;esp -= 4;</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+  for(i = 0; i &lt; NOFILE; i++)</span>
<span class="hljs-addition">+    if(curproc-&gt;ofile[i])</span>
<span class="hljs-addition">+      np-&gt;ofile[i] = filedup(curproc-&gt;ofile[i]);</span>
<span class="hljs-addition">+  np-&gt;cwd = idup(curproc-&gt;cwd);</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+  safestrcpy(np-&gt;name, curproc-&gt;name, sizeof(curproc-&gt;name));</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+  pid = np-&gt;pid;</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+  acquire(&amp;ptable.lock);</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+  np-&gt;state = RUNNABLE;</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+  release(&amp;ptable.lock);</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+  return pid;</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+int</span>
<span class="hljs-addition">+join(void **stack)</span>
<span class="hljs-addition">+{</span>
<span class="hljs-addition">+  struct proc *p;</span>
<span class="hljs-addition">+  int havekids, pid;</span>
<span class="hljs-addition">+  struct proc *curproc = myproc();</span>
<span class="hljs-addition">+  </span>
<span class="hljs-addition">+  acquire(&amp;ptable.lock);</span>
<span class="hljs-addition">+  for(;;){</span>
<span class="hljs-addition">+    // Scan through table looking for exited children.</span>
<span class="hljs-addition">+    havekids = 0;</span>
<span class="hljs-addition">+    for(p = ptable.proc; p &lt; &amp;ptable.proc[NPROC]; p++){</span>
<span class="hljs-addition">+      if(p-&gt;parent != curproc || p-&gt;isthread != 1)</span>
<span class="hljs-addition">+        continue;</span>
<span class="hljs-addition">+      havekids = 1;</span>
<span class="hljs-addition">+      if(p-&gt;state == ZOMBIE){</span>
<span class="hljs-addition">+        // Found one.</span>
<span class="hljs-addition">+        pid = p-&gt;pid;</span>
<span class="hljs-addition">+        kfree(p-&gt;kstack);</span>
<span class="hljs-addition">+        p-&gt;kstack = 0;</span>
<span class="hljs-addition">+        p-&gt;pid = 0;</span>
<span class="hljs-addition">+        p-&gt;parent = 0;</span>
<span class="hljs-addition">+        p-&gt;name[0] = 0;</span>
<span class="hljs-addition">+        p-&gt;killed = 0;</span>
<span class="hljs-addition">+        p-&gt;state = UNUSED;</span>
<span class="hljs-addition">+        release(&amp;ptable.lock);</span>
<span class="hljs-addition">+        return pid;</span>
<span class="hljs-addition">+      }</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+    // No point waiting if we don't have any children.</span>
<span class="hljs-addition">+    if(!havekids || curproc-&gt;killed){</span>
<span class="hljs-addition">+      release(&amp;ptable.lock);</span>
<span class="hljs-addition">+      return -1;</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+    // Wait for children to exit.  (See wakeup1 call in proc_exit.)</span>
<span class="hljs-addition">+    sleep(curproc, &amp;ptable.lock);  //DOC: wait-sleep</span>
<span class="hljs-addition">+    *(int*)stack = curproc-&gt;stack;</span>
<span class="hljs-addition">+  }</span>
<span class="hljs-addition">+}</span>

</code></pre><p>In <code>syscall.h</code>, we add some system call numbers.</p><pre><code class="diff hljs"><span class="hljs-meta">@@ -24,3 +24,5 @@</span>
 #define SYS_sem_destroy 23
 #define SYS_sem_wait    24
 #define SYS_sem_signal  25
<span class="hljs-addition">+#define SYS_clone  26</span>
<span class="hljs-addition">+#define SYS_join   27</span>
</code></pre><p>In <code>syscall.c</code>, we add system call wrapper prototype for thread.</p><pre><code class="diff hljs">@@ -107,6 +107,8 @@ extern int sys_sem_init(void);
 extern int sys_sem_destroy(void);
 extern int sys_sem_wait(void);
 extern int sys_sem_signal(void);
<span class="hljs-addition">+extern int sys_clone(void);</span>
<span class="hljs-addition">+extern int sys_join(void);</span>
 
 static int (*syscalls[])(void) = {
 [SYS_fork]    sys_fork,
@@ -133,7 +135,9 @@ static int (*syscalls[])(void) = {
 [SYS_sem_init]     sys_sem_init,
 [SYS_sem_destroy]  sys_sem_destroy,
 [SYS_sem_wait]     sys_sem_wait,
<span class="hljs-deletion">-[SYS_sem_signal]   sys_sem_signal</span>
<span class="hljs-addition">+[SYS_sem_signal]   sys_sem_signal,</span>
<span class="hljs-addition">+[SYS_clone]   sys_clone,</span>
<span class="hljs-addition">+[SYS_join]   sys_join</span>
 };

</code></pre><p>In <code>sysproc.c</code>, we implement system call wrapper for thread.</p><pre><code class="diff hljs">@@ -128,3 +128,23 @@ sys_sem_signal(void)
 
   return sem_signal(num, count);
 }
<span class="hljs-addition">+</span>
<span class="hljs-addition">+int</span>
<span class="hljs-addition">+sys_clone(void)</span>
<span class="hljs-addition">+{</span>
<span class="hljs-addition">+  int function, arg, stack;</span>
<span class="hljs-addition">+  if(argint(0, &amp;function) &lt; 0) return -1;</span>
<span class="hljs-addition">+  if(argint(1, &amp;arg) &lt; 0) return -1;</span>
<span class="hljs-addition">+  if(argint(2, &amp;stack) &lt; 0) return -1;</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+  return clone((void*)function, (void*)arg, (void*)stack);</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+int</span>
<span class="hljs-addition">+sys_join(void)</span>
<span class="hljs-addition">+{</span>
<span class="hljs-addition">+  int stack;</span>
<span class="hljs-addition">+  if(argint(0, &amp;stack) &lt; 0) return -1;</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+  return join((void**)stack);</span>
<span class="hljs-addition">+}</span>

</code></pre><p>In <code>user.h</code>, we add system call prototype for user program.</p><pre><code class="diff hljs">@@ -27,6 +27,8 @@ int sem_init(int, int);
 int sem_destroy(int);
 int sem_wait(int, int);
 int sem_signal(int, int);
<span class="hljs-addition">+int clone(void*, void*, void*);</span>
<span class="hljs-addition">+int join(void**);</span>
</code></pre><p>In <code>usys.S</code>, we add system calls to system call table.</p><pre><code class="diff hljs">@@ -33,3 +33,5 @@ SYSCALL(sem_init)
 SYSCALL(sem_destroy)
 SYSCALL(sem_wait)
 SYSCALL(sem_signal)
<span class="hljs-addition">+SYSCALL(clone)</span>
<span class="hljs-addition">+SYSCALL(join)</span>
</code></pre><hr><h1 id="üòé-ÁµêË´ñ"><a class="anchor hidden-xs" href="#üòé-ÁµêË´ñ" title="üòé-ÁµêË´ñ"><span class="octicon octicon-link"></span></a>üòé ÁµêË´ñ</h1><p>In this project, I think the implementation of the kernel thread is quite straight forward. All we need to do is modifying old system calls. However, dealing with race condition is not that easy. We have to think about when to acquire spinlock and when to release. We also need to well considered all the possible scenarios during the development. In sum, I learnt a lot from this project.</p><hr><h1 id="üìÖ-ÁµÑÂì°ÂàÜÂ∑•"><a class="anchor hidden-xs" href="#üìÖ-ÁµÑÂì°ÂàÜÂ∑•" title="üìÖ-ÁµÑÂì°ÂàÜÂ∑•"><span class="octicon octicon-link"></span></a>üìÖ ÁµÑÂì°ÂàÜÂ∑•</h1><p>Due to lack of team members, I have to implement all the functions including user test programs.</p><hr></div>
    <div class="ui-toc dropup unselectable hidden-print" style="display:none;">
        <div class="pull-right dropdown">
            <a id="tocLabel" class="ui-toc-label btn btn-default" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false" title="Table of content">
                <i class="fa fa-bars"></i>
            </a>
            <ul id="ui-toc" class="ui-toc-dropdown dropdown-menu" aria-labelledby="tocLabel">
                <div class="toc"><ul class="nav"><li class=""><a href="#106-os-homework-2-2-ÊàêÊûúÂ†±ÂëäÊõ∏">106 OS homework 2-2 ÊàêÊûúÂ†±ÂëäÊõ∏</a></li><li><a href="#üôÇ-‰ΩøÁî®ÊÉÖÂ¢ÉË™™ÊòéÂåÖÂê´ÊµÅÁ®ãÂúñ">üôÇ ‰ΩøÁî®ÊÉÖÂ¢ÉË™™Êòé(ÂåÖÂê´ÊµÅÁ®ãÂúñ)</a><ul class="nav"><li><a href="#first-case">First Case</a></li><li><a href="#second-case">Second Case</a></li><li><a href="#race-condition">Race Condition</a></li><li><a href="#semaphore0">Semaphore</a></li><li><a href="#final-case">Final Case</a></li><li><a href="#flow">Flow</a></li></ul></li><li><a href="#üòá-ÊàêÂäüÁï´Èù¢">üòá ÊàêÂäüÁï´Èù¢</a></li><li class=""><a href="#üèÉ-ÂØ¶‰ΩúÈÅéÁ®ã‰øÆÊîπÂì™‰∫õÊ™îÊ°àÂê´ÂúñÁâá">üèÉ ÂØ¶‰ΩúÈÅéÁ®ã(‰øÆÊîπÂì™‰∫õÊ™îÊ°à[Âê´ÂúñÁâá])</a><ul class="nav"><li class=""><a href="#semaphore">Semaphore</a></li><li class=""><a href="#thread">Thread</a></li></ul></li><li><a href="#üòé-ÁµêË´ñ">üòé ÁµêË´ñ</a></li><li class=""><a href="#üìÖ-ÁµÑÂì°ÂàÜÂ∑•">üìÖ ÁµÑÂì°ÂàÜÂ∑•</a></li></ul></div><div class="toc-menu"><a class="expand-toggle" href="#">Expand all</a><a class="back-to-top" href="#">Back to top</a><a class="go-to-bottom" href="#">Go to bottom</a></div>
            </ul>
        </div>
    </div>
    <div id="ui-toc-affix" class="ui-affix-toc ui-toc-dropdown unselectable hidden-print" data-spy="affix" style="top:17px;display:none;"  >
        <div class="toc"><ul class="nav"><li><a href="#106-os-homework-2-2-ÊàêÊûúÂ†±ÂëäÊõ∏">106 OS homework 2-2 ÊàêÊûúÂ†±ÂëäÊõ∏</a></li><li><a href="#üôÇ-‰ΩøÁî®ÊÉÖÂ¢ÉË™™ÊòéÂåÖÂê´ÊµÅÁ®ãÂúñ">üôÇ ‰ΩøÁî®ÊÉÖÂ¢ÉË™™Êòé(ÂåÖÂê´ÊµÅÁ®ãÂúñ)</a><ul class="nav"><li><a href="#first-case">First Case</a></li><li><a href="#second-case">Second Case</a></li><li><a href="#race-condition">Race Condition</a></li><li><a href="#semaphore0">Semaphore</a></li><li><a href="#final-case">Final Case</a></li><li><a href="#flow">Flow</a></li></ul></li><li><a href="#üòá-ÊàêÂäüÁï´Èù¢">üòá ÊàêÂäüÁï´Èù¢</a></li><li class=""><a href="#üèÉ-ÂØ¶‰ΩúÈÅéÁ®ã‰øÆÊîπÂì™‰∫õÊ™îÊ°àÂê´ÂúñÁâá">üèÉ ÂØ¶‰ΩúÈÅéÁ®ã(‰øÆÊîπÂì™‰∫õÊ™îÊ°à[Âê´ÂúñÁâá])</a><ul class="nav"><li class=""><a href="#semaphore">Semaphore</a></li><li class=""><a href="#thread">Thread</a></li></ul></li><li><a href="#üòé-ÁµêË´ñ">üòé ÁµêË´ñ</a></li><li class=""><a href="#üìÖ-ÁµÑÂì°ÂàÜÂ∑•">üìÖ ÁµÑÂì°ÂàÜÂ∑•</a></li></ul></div><div class="toc-menu"><a class="expand-toggle" href="#">Expand all</a><a class="back-to-top" href="#">Back to top</a><a class="go-to-bottom" href="#">Go to bottom</a></div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gist-embed/2.6.0/gist-embed.min.js" integrity="sha256-KyF2D6xPIJUW5sUDSs93vWyZm+1RzIpKCexxElmxl8g=" crossorigin="anonymous" defer></script>
    <script>
        var markdown = $(".markdown-body");
        //smooth all hash trigger scrolling
        function smoothHashScroll() {
            var hashElements = $("a[href^='#']").toArray();
            for (var i = 0; i < hashElements.length; i++) {
                var element = hashElements[i];
                var $element = $(element);
                var hash = element.hash;
                if (hash) {
                    $element.on('click', function (e) {
                        // store hash
                        var hash = this.hash;
                        if ($(hash).length <= 0) return;
                        // prevent default anchor click behavior
                        e.preventDefault();
                        // animate
                        $('body, html').stop(true, true).animate({
                            scrollTop: $(hash).offset().top
                        }, 100, "linear", function () {
                            // when done, add hash to url
                            // (default click behaviour)
                            window.location.hash = hash;
                        });
                    });
                }
            }
        }

        smoothHashScroll();
        var toc = $('.ui-toc');
        var tocAffix = $('.ui-affix-toc');
        var tocDropdown = $('.ui-toc-dropdown');
        //toc
        tocDropdown.click(function (e) {
            e.stopPropagation();
        });

        var enoughForAffixToc = true;

        function generateScrollspy() {
            $(document.body).scrollspy({
                target: ''
            });
            $(document.body).scrollspy('refresh');
            if (enoughForAffixToc) {
                toc.hide();
                tocAffix.show();
            } else {
                tocAffix.hide();
                toc.show();
            }
            $(document.body).scroll();
        }

        function windowResize() {
            //toc right
            var paddingRight = parseFloat(markdown.css('padding-right'));
            var right = ($(window).width() - (markdown.offset().left + markdown.outerWidth() - paddingRight));
            toc.css('right', right + 'px');
            //affix toc left
            var newbool;
            var rightMargin = (markdown.parent().outerWidth() - markdown.outerWidth()) / 2;
            //for ipad or wider device
            if (rightMargin >= 133) {
                newbool = true;
                var affixLeftMargin = (tocAffix.outerWidth() - tocAffix.width()) / 2;
                var left = markdown.offset().left + markdown.outerWidth() - affixLeftMargin;
                tocAffix.css('left', left + 'px');
            } else {
                newbool = false;
            }
            if (newbool != enoughForAffixToc) {
                enoughForAffixToc = newbool;
                generateScrollspy();
            }
        }
        $(window).resize(function () {
            windowResize();
        });
        $(document).ready(function () {
            windowResize();
            generateScrollspy();
        });

        //remove hash
        function removeHash() {
            window.location.hash = '';
        }

        var backtotop = $('.back-to-top');
        var gotobottom = $('.go-to-bottom');

        backtotop.click(function (e) {
            e.preventDefault();
            e.stopPropagation();
            if (scrollToTop)
                scrollToTop();
            removeHash();
        });
        gotobottom.click(function (e) {
            e.preventDefault();
            e.stopPropagation();
            if (scrollToBottom)
                scrollToBottom();
            removeHash();
        });

        var toggle = $('.expand-toggle');
        var tocExpand = false;

        checkExpandToggle();
        toggle.click(function (e) {
            e.preventDefault();
            e.stopPropagation();
            tocExpand = !tocExpand;
            checkExpandToggle();
        })

        function checkExpandToggle () {
            var toc = $('.ui-toc-dropdown .toc');
            var toggle = $('.expand-toggle');
            if (!tocExpand) {
                toc.removeClass('expand');
                toggle.text('Expand all');
            } else {
                toc.addClass('expand');
                toggle.text('Collapse all');
            }
        }

        function scrollToTop() {
            $('body, html').stop(true, true).animate({
                scrollTop: 0
            }, 100, "linear");
        }

        function scrollToBottom() {
            $('body, html').stop(true, true).animate({
                scrollTop: $(document.body)[0].scrollHeight
            }, 100, "linear");
        }
    </script>
</body>

</html>
